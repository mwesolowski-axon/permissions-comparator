<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Permissions Comparator | Axon</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='125 125 500 500'%3E%3Crect x='0' y='0' width='750' height='750' fill='%23000'/%3E%3Cpath fill='%23FFD200' d='M551.1,485.1c1.2,1.4,3.4-.2,2.5-1.8l-138.8-240.5h0s-26.2-45.4-26.2-45.4c-1.1-2-2.9-2.1-3.9-2-1,.1-2.6.6-3.3,2.7l-37.8,126.1c-5.9,19.7,8.9,39.6,29.5,39.6h37.9c21.9,0,42.8,9.5,57.2,26l83,95.2Z'/%3E%3Cpath fill='%23FFD200' d='M317.3,332.5l29.4-98.3c.5-1.7-1.9-2.8-2.8-1.2l-168.4,291.7c-1.1,2-.4,3.6.5,4.6.9,1,2.3,1.9,4.5,1l.5-.2,149.5-55c17.9-6.6,25.6-27.7,16-44.3l-22.3-38.7c-10.4-18.1-13-39.7-7-59.7Z'/%3E%3Cpath fill='%23FFD200' d='M526.3,552.5h44.7c2.2,0,3.2-1.4,3.6-2.3.4-.8.9-2.5-.5-4.1l-112.6-129c-13.9-15.9-39.3-13.4-49.8,4.8l-21.5,37.1c-8.9,15.4-22.9,27.2-39.6,33.3l-156.6,57.4c-1.6.6-1.2,2.9.5,2.9h331.7Z'/%3E%3C/svg%3E">
<style>
:root {
  --axon-yellow: #FFD200;
  --axon-yellow-dark: #E6BD00;
  --axon-black: #000000;
  --axon-white: #FFFFFF;
  --axon-gray-100: #F5F5F5;
  --axon-gray-200: #E0E0E0;
  --axon-gray-300: #BDBDBD;
  --axon-gray-600: #757575;
  --axon-gray-800: #424242;
  --axon-gray-900: #212121;
  --green: #0A7A0A;
  --red: #B00020;
}

/* Dark mode styles */
body.dark-mode {
  --axon-gray-100: #1a1a1a;
  --axon-gray-200: #2d2d2d;
  --axon-gray-300: #404040;
  --axon-gray-600: #888888;
  --axon-gray-800: #cccccc;
  --axon-gray-900: #f0f0f0;
}

body.dark-mode .header {
  background: var(--axon-yellow);
}

body.dark-mode .header-title {
  color: var(--axon-black);
}

body.dark-mode .header-divider {
  background: rgba(0, 0, 0, 0.3);
}

body.dark-mode .logo svg path {
  fill: var(--axon-black);
}


body.dark-mode .theme-toggle svg {
  fill: var(--axon-black);
}

body.dark-mode .theme-toggle .dark-icon {
  display: block;
}

body.dark-mode .theme-toggle .light-icon {
  display: none;
}

body.dark-mode .upload-section,
body.dark-mode .stat-card,
body.dark-mode .controls,
body.dark-mode .table-container {
  background: var(--axon-gray-200);
  border-color: var(--axon-gray-300);
}

body.dark-mode .file-group {
  background: var(--axon-gray-300);
  border-color: var(--axon-gray-600);
}

body.dark-mode .file-group:hover {
  border-color: var(--axon-yellow);
}

body.dark-mode .search-box {
  background: var(--axon-gray-300);
  border-color: var(--axon-gray-600);
  color: var(--axon-gray-900);
}

body.dark-mode thead {
  background: #2d2d2d;
}

body.dark-mode th {
  color: var(--axon-yellow);
}

body.dark-mode td {
  border-color: var(--axon-gray-300);
}

body.dark-mode tbody tr:nth-child(even) {
  background: var(--axon-gray-200);
}

body.dark-mode tbody tr:hover {
  background: var(--axon-gray-300);
}

body.dark-mode .footer {
  color: var(--axon-gray-600);
}

body.dark-mode .btn-compare:disabled {
  background: var(--axon-gray-300);
  color: var(--axon-gray-600);
}

body.dark-mode .btn-csv {
  background: var(--axon-yellow);
  color: var(--axon-black);
}

body.dark-mode .btn-csv:hover {
  background: var(--axon-yellow-dark);
}

body.dark-mode .file-group.has-file {
  border-color: var(--green);
}

body.dark-mode .file-group label {
  color: var(--axon-gray-900);
}

body.dark-mode .filter-group label span {
  color: var(--axon-gray-900);
}

body.dark-mode h1 {
  color: var(--axon-gray-900);
}

body.dark-mode .subtitle {
  color: var(--axon-gray-600);
}

* {
  box-sizing: border-box;
}

body {
  font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, Roboto, Helvetica, Arial, sans-serif;
  background: var(--axon-gray-100);
  color: var(--axon-gray-900);
  margin: 0;
  min-height: 100vh;
  padding: 0;
  transition: background-color 0.3s ease, color 0.3s ease;
}

.header {
  background: var(--axon-black);
  padding: 12px 24px;
  display: flex;
  align-items: center;
  gap: 16px;
}

.header-left {
  display: flex;
  align-items: center;
  gap: 16px;
  flex: 1;
}

.theme-toggle {
  background: transparent;
  border: none;
  padding: 8px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
  opacity: 0.9;
}

.theme-toggle:hover {
  opacity: 1;
  transform: scale(1.1);
}

.theme-toggle svg {
  width: 24px;
  height: 24px;
  fill: var(--axon-yellow);
}

.theme-toggle .dark-icon {
  display: none;
}

.theme-toggle .light-icon {
  display: block;
}

.logo {
  height: 72px;
  width: auto;
}

.logo svg {
  height: 100%;
  width: auto;
}

.header-divider {
  width: 2px;
  height: 24px;
  background: var(--axon-gray-600);
}

.header-title {
  color: var(--axon-white);
  font-size: 1rem;
  font-weight: 400;
}

.container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 32px 24px;
}

h1 {
  text-align: center;
  font-size: 2rem;
  font-weight: 600;
  margin-bottom: 8px;
  color: var(--axon-gray-900);
}

.subtitle {
  text-align: center;
  color: var(--axon-gray-600);
  margin-bottom: 32px;
  font-size: 1rem;
}

.upload-section {
  background: var(--axon-white);
  border-radius: 8px;
  padding: 32px;
  margin-bottom: 24px;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  border: 1px solid var(--axon-gray-200);
}

.file-inputs {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 20px;
  margin-bottom: 28px;
}

.file-group {
  background: var(--axon-gray-100);
  border-radius: 8px;
  padding: 20px;
  border: 2px dashed var(--axon-gray-300);
  transition: all 0.2s ease;
}

.file-group:hover {
  border-color: var(--axon-yellow);
  background: rgba(255, 210, 0, 0.05);
}

.file-group.has-file {
  border-color: var(--green);
  border-style: solid;
  background: rgba(10, 122, 10, 0.05);
}

.file-group label {
  display: block;
  font-weight: 600;
  margin-bottom: 12px;
  color: var(--axon-gray-900);
}

.file-group input[type="file"] {
  width: 100%;
  padding: 10px;
  background: transparent;
  border: none;
  color: var(--axon-gray-800);
  cursor: pointer;
}

.file-group input[type="file"]::file-selector-button {
  background: var(--axon-yellow);
  color: var(--axon-black);
  border: none;
  padding: 10px 20px;
  border-radius: 4px;
  cursor: pointer;
  font-weight: 600;
  margin-right: 12px;
  transition: all 0.2s ease;
}

.file-group input[type="file"]::file-selector-button:hover {
  background: var(--axon-yellow-dark);
}

.file-name {
  font-size: 0.85rem;
  color: var(--axon-gray-600);
  margin-top: 8px;
  word-break: break-all;
}

.optional-tag {
  font-size: 0.75rem;
  color: var(--axon-gray-600);
  font-weight: normal;
}

.file-group {
  position: relative;
}

.btn-remove-file {
  position: absolute;
  top: 10px;
  right: 10px;
  background: transparent;
  border: none;
  color: var(--axon-gray-600);
  font-size: 1.5rem;
  cursor: pointer;
  padding: 0 8px;
  line-height: 1;
  transition: color 0.2s ease;
}

.btn-remove-file:hover {
  color: var(--red);
}

.add-file-c-container {
  text-align: center;
  margin-bottom: 20px;
}

.btn-add-file {
  background: transparent;
  border: 2px dashed var(--axon-gray-300);
  color: var(--axon-gray-600);
  padding: 12px 24px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 0.95rem;
  transition: all 0.2s ease;
}

.btn-add-file:hover {
  border-color: var(--axon-yellow);
  color: var(--axon-yellow-dark);
  background: rgba(255, 210, 0, 0.05);
}

body.dark-mode .btn-add-file {
  border-color: var(--axon-gray-600);
  color: var(--axon-gray-600);
}

body.dark-mode .btn-add-file:hover {
  border-color: var(--axon-yellow);
  color: var(--axon-yellow);
}

.btn-compare {
  display: block;
  width: 100%;
  max-width: 280px;
  margin: 0 auto;
  padding: 14px 32px;
  font-size: 1rem;
  font-weight: 700;
  background: var(--axon-yellow);
  color: var(--axon-black);
  border: none;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.2s ease;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.btn-compare:hover {
  background: var(--axon-yellow-dark);
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(255, 210, 0, 0.4);
}

.btn-compare:disabled {
  background: var(--axon-gray-300);
  color: var(--axon-gray-600);
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}

.results-section {
  display: none;
  animation: fadeIn 0.4s ease;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(16px); }
  to { opacity: 1; transform: translateY(0); }
}

.summary {
  display: flex;
  gap: 24px;
  justify-content: center;
  flex-wrap: wrap;
  margin-bottom: 24px;
}

.stat-card {
  background: var(--axon-white);
  border-radius: 8px;
  padding: 24px 48px;
  text-align: center;
  min-width: 160px;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  border: 1px solid var(--axon-gray-200);
}

.stat-card.match {
  border-left: 4px solid var(--green);
}

.stat-card.mismatch {
  border-left: 4px solid var(--red);
}

.stat-number {
  font-size: 2.5rem;
  font-weight: 700;
}

.stat-card.match .stat-number {
  color: var(--green);
}

.stat-card.mismatch .stat-number {
  color: var(--red);
}

.stat-label {
  font-size: 0.9rem;
  color: var(--axon-gray-600);
  margin-top: 4px;
  font-weight: 500;
}

.controls {
  display: flex;
  gap: 20px;
  flex-wrap: wrap;
  align-items: center;
  margin-bottom: 16px;
  padding: 16px 20px;
  background: var(--axon-white);
  border-radius: 8px;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  border: 1px solid var(--axon-gray-200);
}

.search-box {
  flex: 1;
  min-width: 200px;
  padding: 12px 16px;
  font-size: 1rem;
  background: var(--axon-gray-100);
  border: 1px solid var(--axon-gray-300);
  border-radius: 4px;
  color: var(--axon-gray-900);
  outline: none;
  transition: border-color 0.2s ease, box-shadow 0.2s ease;
}

.search-box:focus {
  border-color: var(--axon-yellow);
  box-shadow: 0 0 0 3px rgba(255, 210, 0, 0.2);
}

.search-box::placeholder {
  color: var(--axon-gray-600);
}

.filter-group {
  display: flex;
  gap: 16px;
}

.filter-group label {
  display: flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;
  user-select: none;
  color: var(--axon-gray-800);
  font-weight: 500;
}

.filter-group input[type="checkbox"] {
  width: 18px;
  height: 18px;
  accent-color: var(--axon-yellow);
  cursor: pointer;
}

.btn-csv {
  padding: 12px 24px;
  font-weight: 600;
  background: var(--axon-black);
  color: var(--axon-white);
  border: none;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.btn-csv:hover {
  background: var(--axon-gray-800);
}

.table-container {
  background: var(--axon-white);
  border-radius: 8px;
  overflow-x: auto;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  border: 1px solid var(--axon-gray-200);
}

table {
  width: 100%;
  border-collapse: collapse;
  table-layout: fixed;
}

/* Column widths */
th:nth-child(1), td:nth-child(1) { 
  width: 18%; 
  min-width: 150px;
  overflow: hidden;
  text-overflow: ellipsis;
  word-wrap: break-word;
  overflow-wrap: break-word;
} /* Category */
th:nth-child(2), td:nth-child(2) { 
  width: auto;
  overflow: hidden;
  text-overflow: ellipsis;
  word-wrap: break-word;
  overflow-wrap: break-word;
} /* Description - takes remaining space */
th.file-col { 
  width: 10%;
  min-width: 70px;
  max-width: 100px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
td.file-col {
  width: 10%;
  min-width: 70px;
  max-width: 100px;
  text-align: center;
}
th:last-child, td:last-child { width: 8%; min-width: 70px; } /* Status */

thead {
  background: var(--axon-black);
}

th {
  padding: 16px 14px;
  text-align: left;
  font-weight: 600;
  color: var(--axon-white);
  border-bottom: 3px solid var(--axon-yellow);
}

th.sortable {
  cursor: pointer;
  transition: background 0.2s ease;
}

th.sortable:hover {
  background: var(--axon-gray-800);
}

th.active {
  background: var(--axon-gray-800);
}

.sort-arrow {
  margin-left: 8px;
  font-size: 0.8em;
  color: var(--axon-yellow);
}

td {
  padding: 14px;
  border-bottom: 1px solid var(--axon-gray-200);
  color: var(--axon-gray-800);
}

tbody tr {
  transition: background 0.2s ease;
}

tbody tr:hover {
  background: var(--axon-gray-100);
}

tbody tr:nth-child(even) {
  background: var(--axon-gray-100);
}

tbody tr:nth-child(even):hover {
  background: var(--axon-gray-200);
}

.val-true {
  color: var(--green);
  font-weight: 700;
  font-size: 1.2rem;
}

.val-false {
  color: var(--red);
  font-weight: 700;
  font-size: 1.2rem;
}

.val-missing {
  color: var(--axon-yellow-dark);
  font-weight: 700;
  font-size: 1.2rem;
}

.status-match {
  color: var(--green);
  font-weight: 700;
}

.status-mismatch {
  color: var(--red);
  font-weight: 700;
}

.no-results {
  text-align: center;
  padding: 48px;
  color: var(--axon-gray-600);
  font-size: 1.1rem;
}

.error-message {
  background: rgba(176, 0, 32, 0.1);
  border: 1px solid var(--red);
  color: var(--red);
  padding: 16px 20px;
  border-radius: 4px;
  margin-bottom: 20px;
  display: none;
  font-weight: 500;
}

.footer {
  text-align: center;
  padding: 24px;
  color: var(--axon-gray-600);
  font-size: 0.85rem;
}

@media (max-width: 768px) {
  h1 {
    font-size: 1.5rem;
  }
  
  .controls {
    flex-direction: column;
    align-items: stretch;
  }
  
  .search-box {
    width: 100%;
  }
  
  .filter-group {
    justify-content: center;
  }
  
  .btn-csv {
    width: 100%;
  }
  
  th, td {
    padding: 10px 8px;
    font-size: 0.9rem;
  }
  
  .header {
    flex-direction: column;
    text-align: center;
    gap: 8px;
  }
  
  .header-divider {
    display: none;
  }
}
</style>
</head>
<body>

<div class="header">
  <div class="header-left">
    <div class="logo">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1350 556">
        <g>
          <g>
            <path fill="#FFD200" d="M382.2,335.7c.6.7,1.8,0,1.3-.9l-73.9-128h0s-13.9-24.2-13.9-24.2c-.6-1-1.5-1.1-2.1-1-.5,0-1.4.3-1.8,1.4l-20.1,67.1c-3.2,10.5,4.7,21.1,15.7,21.1h20.2c11.7,0,22.8,5.1,30.5,13.9l44.2,50.7Z"/>
            <path fill="#FFD200" d="M257.8,254.4l15.7-52.3c.3-.9-1-1.5-1.5-.6l-89.7,155.3c-.6,1.1-.2,1.9.3,2.4.5.5,1.2,1,2.4.5h.3c0-.1,79.6-29.4,79.6-29.4,9.5-3.5,13.6-14.8,8.5-23.6l-11.9-20.6c-5.6-9.6-6.9-21.1-3.7-31.8"/>
            <path fill="#FFD200" d="M369,371.5h23.8c1.2,0,1.7-.8,1.9-1.2.2-.4.5-1.3-.2-2.2l-59.9-68.7c-7.4-8.5-20.9-7.2-26.5,2.6l-11.4,19.7c-4.7,8.2-12.2,14.5-21.1,17.7l-83.4,30.5c-.8.3-.6,1.6.3,1.6h176.6Z"/>
          </g>
          <g>
            <path fill="#FFD200" d="M522.2,190.1c-6.5,0-12.3,3.9-14.8,9.8l-75.9,170.8h19.5l21-47.2h81.4c2.1,0,4.1-1.3,4.9-3.2l6.8-15.2h-84.9l40.5-91.2c.6-1.3,2.4-1.3,2.9,0l69.6,156.8h19.5l-75.9-170.7c-2.5-6-8.3-9.9-14.8-9.9Z"/>
            <path fill="#FFD200" d="M880.7,181.1c-53.4,0-96.9,43.4-96.9,96.9s43.4,96.8,96.9,96.8,96.9-43.4,96.9-96.8-43.4-96.9-96.9-96.9ZM960,278c0,43.8-35.6,79.4-79.4,79.4s-79.4-35.6-79.4-79.4,35.6-79.4,79.4-79.4,79.4,35.6,79.4,79.4Z"/>
            <path fill="#FFD200" d="M779,185.6h-21.1l-54.3,80.6c-1.1,1.6-3.8,1.6-4.9,0l-54.3-80.6h-21.1l60.9,90.4c.8,1.2.8,2.7,0,3.9l-60.9,90.4h21.1l54.3-80.6c1.1-1.6,3.8-1.6,4.9,0l54.3,80.6h21.1l-60.9-90.4c-.8-1.2-.8-2.7,0-3.9l60.9-90.4Z"/>
            <path fill="#FFD200" d="M1150.5,185.6v156.2l-113.7-150.6c-3.7-4.6-9.4-7-15.4-6.3-8.5,1-15,8.5-15,17.3v168.2h17.5v-167.2l126.2,167.2h17.8v-184.8h-17.5Z"/>
          </g>
        </g>
      </svg>
    </div>
    <div class="header-divider"></div>
    <div class="header-title">Permissions Comparator</div>
  </div>
  <button class="theme-toggle" onclick="toggleTheme()" title="Toggle dark/light mode">
    <svg class="light-icon" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
      <path d="M100 0C155.228 0 200 44.7715 200 100C200 155.228 155.228 200 100 200C44.7715 200 0 155.228 0 100C0 44.7715 44.7715 0 100 0ZM100 9C50.2944 9 10 49.2944 10 99C10 148.317 49.6673 188.369 98.8369 188.992L100 189V9Z"/>
    </svg>
    <svg class="dark-icon" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
      <path d="M100 0C155.228 0 200 44.7715 200 100C200 155.228 155.228 200 100 200C44.7715 200 0 155.228 0 100C0 44.7715 44.7715 0 100 0ZM100 9C50.2944 9 10 49.2944 10 99C10 148.317 49.6673 188.369 98.8369 188.992L100 189V9Z"/>
    </svg>
  </button>
</div>

<div class="container">
  <h1>Team Permissions Comparator</h1>
  <p class="subtitle">Compare permission settings across JSON configuration files</p>
  
  <div class="upload-section">
    <div class="file-inputs">
      <div class="file-group" id="group-a">
        <label>File A (Required)</label>
        <input type="file" id="file-a" accept=".json" onchange="handleFileSelect(this, 'a')">
        <div class="file-name" id="name-a">No file selected</div>
      </div>
      <div class="file-group" id="group-b">
        <label>File B (Required)</label>
        <input type="file" id="file-b" accept=".json" onchange="handleFileSelect(this, 'b')">
        <div class="file-name" id="name-b">No file selected</div>
      </div>
      <div class="file-group" id="group-c" style="display: none;">
        <label>File C <span class="optional-tag">(Optional)</span></label>
        <input type="file" id="file-c" accept=".json" onchange="handleFileSelect(this, 'c')">
        <div class="file-name" id="name-c">No file selected</div>
        <button class="btn-remove-file" onclick="removeFileC()" title="Remove File C">×</button>
      </div>
    </div>
    <div class="add-file-c-container" id="add-file-c-container" style="display: none;">
      <button class="btn-add-file" id="btn-add-file-c" onclick="showFileC()">+ Add a third file to compare</button>
    </div>
    <button class="btn-compare" id="btn-compare" onclick="compareFiles()" disabled>Compare Files</button>
  </div>

  <div class="error-message" id="error-msg"></div>

  <div class="results-section" id="results">
    <div class="summary">
      <div class="stat-card match">
        <div class="stat-number" id="stat-match">0</div>
        <div class="stat-label">Matched</div>
      </div>
      <div class="stat-card mismatch">
        <div class="stat-number" id="stat-mismatch">0</div>
        <div class="stat-label">Mismatched</div>
      </div>
    </div>

    <div class="controls">
      <input type="text" class="search-box" id="search" placeholder="Search permissions..." onkeyup="applyFilters()">
      <div class="filter-group">
        <label>
          <input type="checkbox" id="filter-match" checked onchange="applyFilters()">
          <span>Matches</span>
        </label>
        <label>
          <input type="checkbox" id="filter-mismatch" checked onchange="applyFilters()">
          <span>Mismatches</span>
        </label>
      </div>
      <button class="btn-csv" onclick="downloadCSV()">Download CSV</button>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th class="sortable" onclick="sortTable(0)">Category</th>
            <th class="sortable" onclick="sortTable(1)">Description</th>
            <th id="th-a" class="file-col" title="">File A</th>
            <th id="th-b" class="file-col" title="">File B</th>
            <th id="th-c" class="file-col" style="display:none" title="">File C</th>
            <th class="sortable" onclick="sortTable(5)">Status</th>
          </tr>
        </thead>
        <tbody id="table-body"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
// Theme toggle
function toggleTheme() {
  document.body.classList.toggle('dark-mode');
  // Save preference to localStorage
  const isDark = document.body.classList.contains('dark-mode');
  localStorage.setItem('theme', isDark ? 'dark' : 'light');
}

// Load saved theme preference on page load
(function() {
  const savedTheme = localStorage.getItem('theme');
  if (savedTheme === 'dark') {
    document.body.classList.add('dark-mode');
  }
})();

// State
let files = { a: null, b: null, c: null };
let fileNames = { a: '', b: '', c: '' };
let tableData = [];
let sortState = {};
let hasFileC = false;

function handleFileSelect(input, key) {
  const file = input.files[0];
  const group = document.getElementById(`group-${key}`);
  const nameEl = document.getElementById(`name-${key}`);
  
  if (file) {
    files[key] = file;
    fileNames[key] = file.name;
    nameEl.textContent = file.name;
    group.classList.add('has-file');
  } else {
    files[key] = null;
    fileNames[key] = '';
    nameEl.textContent = 'No file selected';
    group.classList.remove('has-file');
  }
  
  updateCompareButton();
}

function updateCompareButton() {
  const btn = document.getElementById('btn-compare');
  btn.disabled = !(files.a && files.b);
  
  // Show "Add File C" button only when both A and B are selected and C is not visible
  const addFileCContainer = document.getElementById('add-file-c-container');
  const groupC = document.getElementById('group-c');
  if (files.a && files.b && groupC.style.display === 'none') {
    addFileCContainer.style.display = 'block';
  } else if (!files.a || !files.b) {
    addFileCContainer.style.display = 'none';
  }
}

function showFileC() {
  document.getElementById('group-c').style.display = 'block';
  document.getElementById('add-file-c-container').style.display = 'none';
}

function removeFileC() {
  // Clear the file input
  const fileInput = document.getElementById('file-c');
  fileInput.value = '';
  files.c = null;
  fileNames.c = '';
  document.getElementById('name-c').textContent = 'No file selected';
  document.getElementById('group-c').classList.remove('has-file');
  
  // Hide File C and show the add button again
  document.getElementById('group-c').style.display = 'none';
  document.getElementById('add-file-c-container').style.display = 'block';
}

function showError(message) {
  const el = document.getElementById('error-msg');
  el.textContent = message;
  el.style.display = 'block';
  setTimeout(() => { el.style.display = 'none'; }, 5000);
}

async function readFile(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = e => {
      try {
        resolve(JSON.parse(e.target.result));
      } catch (err) {
        reject(new Error(`Invalid JSON in ${file.name}`));
      }
    };
    reader.onerror = () => reject(new Error(`Failed to read ${file.name}`));
    reader.readAsText(file);
  });
}

function extractPrivileges(data) {
  // Match Python logic: extract from d[0]["privileges"]
  const result = {};
  try {
    const privileges = data[0].privileges;
    for (const p of privileges) {
      // Normalize whitespace to collapse duplicate entries with varying spaces
      const desc = (p.description || '').replace(/\s+/g, ' ').trim();
      const cat = (p.categories[0] || '').replace(/\s+/g, ' ').trim();
      // Use .get("enabled") equivalent - returns undefined if missing
      result[`${desc}|||${cat}`] = p.hasOwnProperty('enabled') ? p.enabled : undefined;
    }
  } catch (err) {
    console.error('Error extracting privileges:', err);
  }
  return result;
}

function icon(value) {
  if (value === true) return { symbol: '✓', cssClass: 'val-true' };
  if (value === false) return { symbol: '✗', cssClass: 'val-false' };
  return { symbol: '⌀', cssClass: 'val-missing' };
}

async function compareFiles() {
  const errorEl = document.getElementById('error-msg');
  errorEl.style.display = 'none';
  
  try {
    const [dataA, dataB] = await Promise.all([
      readFile(files.a),
      readFile(files.b)
    ]);
    
    let dataC = null;
    hasFileC = !!(files.c);
    if (hasFileC) {
      dataC = await readFile(files.c);
    }
    
    const A = extractPrivileges(dataA);
    const B = extractPrivileges(dataB);
    const C = hasFileC ? extractPrivileges(dataC) : {};
    
    // Get all unique keys
    const allKeys = new Set([...Object.keys(A), ...Object.keys(B), ...Object.keys(C)]);
    
    tableData = [];
    let matched = 0, mismatched = 0;
    
    for (const key of allKeys) {
      const [desc, cat] = key.split('|||');
      const valA = A[key];
      const valB = B[key];
      const valC = hasFileC ? C[key] : undefined;
      
      // Match Python logic: compare raw values without string conversion
      // Python: is_match = len(set(vals)) == 1
      const vals = hasFileC ? [valA, valB, valC] : [valA, valB];
      const uniqueVals = new Set(vals);
      const isMatch = uniqueVals.size === 1;
      
      if (isMatch) matched++;
      else mismatched++;
      
      const iconA = icon(valA);
      const iconB = icon(valB);
      const iconC = icon(valC);
      
      tableData.push({
        cat,
        desc,
        a: iconA.symbol,
        aClass: iconA.cssClass,
        b: iconB.symbol,
        bClass: iconB.cssClass,
        c: iconC.symbol,
        cClass: iconC.cssClass,
        status: isMatch ? 'Match' : 'Mismatch',
        statusClass: isMatch ? 'status-match' : 'status-mismatch'
      });
    }
    
    // Sort by category, then by description (to match Python behavior)
    tableData.sort((a, b) => {
      const catCompare = a.cat.localeCompare(b.cat);
      if (catCompare !== 0) return catCompare;
      return a.desc.localeCompare(b.desc);
    });
    
    // Update UI
    document.getElementById('stat-match').textContent = matched;
    document.getElementById('stat-mismatch').textContent = mismatched;
    
    // Update file name headers with title for hover tooltip
    const thA = document.getElementById('th-a');
    const thB = document.getElementById('th-b');
    const thC = document.getElementById('th-c');
    thA.textContent = fileNames.a;
    thA.title = fileNames.a;
    thB.textContent = fileNames.b;
    thB.title = fileNames.b;
    thC.textContent = fileNames.c;
    thC.title = fileNames.c;
    thC.style.display = hasFileC ? '' : 'none';
    
    renderTable();
    
    document.getElementById('results').style.display = 'block';
    document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
    
  } catch (err) {
    showError(err.message);
  }
}

function renderTable() {
  const tbody = document.getElementById('table-body');
  const searchText = document.getElementById('search').value.toLowerCase();
  const showMatch = document.getElementById('filter-match').checked;
  const showMismatch = document.getElementById('filter-mismatch').checked;
  
  let html = '';
  let visibleCount = 0;
  
  for (const row of tableData) {
    // Filter by status
    if (row.status === 'Match' && !showMatch) continue;
    if (row.status === 'Mismatch' && !showMismatch) continue;
    
    // Filter by search text
    const rowText = `${row.cat} ${row.desc}`.toLowerCase();
    if (searchText && !rowText.includes(searchText)) continue;
    
    visibleCount++;
    html += `
      <tr data-status="${row.status}">
        <td>${escapeHtml(row.cat)}</td>
        <td>${escapeHtml(row.desc)}</td>
        <td class="file-col ${row.aClass}">${row.a}</td>
        <td class="file-col ${row.bClass}">${row.b}</td>
        ${hasFileC ? `<td class="file-col ${row.cClass}">${row.c}</td>` : ''}
        <td class="${row.statusClass}">${row.status}</td>
      </tr>
    `;
  }
  
  if (visibleCount === 0) {
    html = `<tr><td colspan="${hasFileC ? 6 : 5}" class="no-results">No results found</td></tr>`;
  }
  
  tbody.innerHTML = html;
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function applyFilters() {
  renderTable();
}

function sortTable(colIndex) {
  const key = colIndex;
  sortState[key] = !sortState[key];
  const ascending = sortState[key];
  
  const getVal = (row) => {
    switch(colIndex) {
      case 0: return row.cat;
      case 1: return row.desc;
      case 5: return row.status;
      default: return '';
    }
  };
  
  tableData.sort((a, b) => {
    const av = getVal(a);
    const bv = getVal(b);
    return ascending ? av.localeCompare(bv) : bv.localeCompare(av);
  });
  
  // Update header styling
  document.querySelectorAll('th').forEach((th, i) => {
    th.classList.remove('active');
    const arrow = th.querySelector('.sort-arrow');
    if (arrow) arrow.remove();
  });
  
  const headers = document.querySelectorAll('th');
  const targetHeader = headers[colIndex];
  targetHeader.classList.add('active');
  
  const arrow = document.createElement('span');
  arrow.className = 'sort-arrow';
  arrow.textContent = ascending ? ' ▲' : ' ▼';
  targetHeader.appendChild(arrow);
  
  renderTable();
}

function normalize(val) {
  if (val.includes('✓')) return 'Enabled';
  if (val.includes('✗')) return 'Disabled';
  if (val.includes('⌀')) return 'Missing';
  return val;
}

function downloadCSV() {
  const searchText = document.getElementById('search').value.toLowerCase();
  const showMatch = document.getElementById('filter-match').checked;
  const showMismatch = document.getElementById('filter-mismatch').checked;
  
  const headers = hasFileC 
    ? ['Category', 'Description', fileNames.a, fileNames.b, fileNames.c, 'Status']
    : ['Category', 'Description', fileNames.a, fileNames.b, 'Status'];
  
  const rows = [headers];
  
  for (const row of tableData) {
    if (row.status === 'Match' && !showMatch) continue;
    if (row.status === 'Mismatch' && !showMismatch) continue;
    
    const rowText = `${row.cat} ${row.desc}`.toLowerCase();
    if (searchText && !rowText.includes(searchText)) continue;
    
    const csvRow = hasFileC
      ? [row.cat, row.desc, normalize(row.a), normalize(row.b), normalize(row.c), row.status]
      : [row.cat, row.desc, normalize(row.a), normalize(row.b), row.status];
    
    rows.push(csvRow);
  }
  
  const csv = rows
    .map(r => r.map(c => `"${String(c).replace(/"/g, '""')}"`).join(','))
    .join('\n');
  
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'permissions_compare.csv';
  a.click();
  URL.revokeObjectURL(url);
}
</script>

<div class="footer">
  For Internal Use Only 
</div>

</body>
</html>

